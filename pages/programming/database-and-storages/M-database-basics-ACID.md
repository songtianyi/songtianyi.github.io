# 数据库基础-单机事务

作者: [songtianyi](http://songtianyi.info) create@2020/12/26

## 为什么要学习事务？

大部分时候，我们是不需要关心这些事情的，数据库安装，初始化，建表之后，我们就可以安逸地进行 CRUD 了。但我们也知道，基础理论是一个绕不开的话题，如果你要针对业务做一些优化，那就逃不开了。另外， 业务总是在变化，技术也会被业务驱动着去演进。mongodb，redis，time-series db等等，这些都是因为业务变化而带来的技术更迭。这些变化是我们的负担，我们需要不停地学习新的知识，但更是我们的机会，如果你能在业务变化之前掌握好基础理论，那么在业务变化之时，你才能走在最前沿，去创造一些新的东西。否则，只能写一辈子 CRUD 了。

好了，我们现在弄明白了为什么学，那么继续看看怎么学。

## 为什么数据库需要事务(why)以及什么是事物(what)？

在学习技术之前，搞清楚它的需求背景是及其重要的，不然只能知其然，而不知其所以然。首先，我们得明白一个道理，不管是写业务还是写底层组件，我们写的代码有很多是为了处理异常情况的，比例从 20% 到 %50 不等。

先来看一个简单的例子。

![image](https://songtianyi-blog.oss-cn-shenzhen.aliyuncs.com/database-basics-read-after-write-should-ok.png)

不考虑并发，程序将 score 的值修改为 99之后，读到的值应该是 99 才是符合预期的对吧，这是正常的情况。

![image](https://songtianyi-blog.oss-cn-shenzhen.aliyuncs.com/database-basics-crash-after-write.png)

那么假如 score 被修改为 99 之后，程序崩溃或者机器宕机了怎么办？因为性能的原因，数据库在写入数据的时候是先写到内存，然后刷到磁盘的，那么还未刷入的磁盘的部分，是不是就丢了？

数据库事物，可以认为是解决这些杂七杂八问题的技术组合。在讲之前，我们先抛弃这些概念性的东西，回归到数据库的本质，即数据库设计的目标是什么？用一个大的概念来讲就是 `可靠性` 。数据库系统在经受硬件故障，软件故障，人为错误的“袭击”后，能够恢复到正常状态。而可靠性的背后又包含了方方面面的东西，比如我们前面提到的，buffer 内的数据还未刷入到磁盘的时候机器宕机了怎么办？再比如， 

数据库事物(Transaction)一般指数据库所满足的 ACID 特性，即 原子性(Atomic), 一致性(Consistency), 隔离型(Isolation), 持久性(Durablility). 大多数文章都是按照顺序去讲这些概念以及背后的技术，我习惯从场景出发，然后按照常人的思路逐步展开，浅入浅出，所以这里暂时不介绍这些概念的具体定义。

## 怎么实现(how)?

先来看数据库怎么解决程序崩溃或者机器宕机导致的数据丢失问题。思路也很直接，既然写在内存里会丢，那么写到文件呢？
